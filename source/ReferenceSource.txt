import { ChangeDetectorRef, Component, OnInit, TemplateRef, ViewChild } from '@angular/core';
import { Title } from '@angular/platform-browser';
import { Router } from '@angular/router';
import { CustomizeSettingService } from 'app/services/customize_setting/customize-setting.service';
import { UserSettingService } from 'app/services/api/user-setting.service';
import { CommonHeaderService } from 'app/services/shared/common-header.service';
import { DatePickerService } from 'app/services/shared/date-picker.service';
import { ModalService } from 'app/services/shared/modal.service';
import { NavigationService } from 'app/services/shared/navigation.service';
import { Fields, TableHeader } from 'app/types/common';
import * as _ from 'lodash';
import { AbstractIndexComponent } from '../shared/abstract-component/abstract-index.component';
import { CsNewComponent } from './new/cs-new.component';
import { CsEditComponent } from './edit/cs-edit.component';
import { CsUpdateRequestConfirmComponent } from './update-request-confirm/cs-update-request-confirm.component';

@Component({
  selector: 'app-cs-detail',
  templateUrl: './cs-detail.component.html',
  styleUrls: ['./cs-detail.component.scss']
})
export class CsDetailComponent extends AbstractIndexComponent implements OnInit {

  @ViewChild('csNewModalContent', { static: false }) csNewModalContent: TemplateRef<null>;
  @ViewChild('csEditModalContent', { static: false }) csEditModalContent: TemplateRef<null>;
  @ViewChild('csGetRequestModalContent', { static: false }) csGetRequestModalContent: TemplateRef<null>;
  @ViewChild('csUpdateRequestConfirmModalContent', { static: false }) csUpdateRequestConfirmModalContent: TemplateRef<null>;
  @ViewChild(CsNewComponent) newChildComponent: CsNewComponent;
  @ViewChild(CsEditComponent) editChildComponent: CsEditComponent;
  @ViewChild(CsUpdateRequestConfirmComponent) updateRequestConfirm: CsUpdateRequestConfirmComponent;

  fields: Fields;
  fixedThList: TableHeader[];
  scrollableThList: TableHeader[];
  _searchParams : any;
  usageDefinitionName: string = "Definition Name 01";

  data = {
    resource: {},
    dataTable: {}
  };

  inputParams = {
    regist_customize_usage_definition_version: '',
    edit_start_date_ymd: '',
    edit_end_date_ymd: '',
    regist_active_name: '',
    regist_priority_name: '',
    regist_customize_usage_definition_name: '',
    regist_customize_usage_definition_id: ''
  };
  responseData: any;

  versionInput: string = 'Ver.1';
  startDateInput: string;
  endDateInput: string;
  enabledInput: string = '有効';
  priorityInput: string = '高';

  requestParams = {
    "cars": [
      {
        "car_id": "",
        "request_route_kind": "0"
      }
    ]
  };

  // TODO
  selectedCarId: string = "1";

  customizeLists: any[];

  constructor(
    nav: NavigationService,
    title: Title,
    header: CommonHeaderService,
    router: Router,
    private modal: ModalService,
    private cdRef: ChangeDetectorRef,
    private customSettingService: CustomizeSettingService,
    protected userSettingService: UserSettingService,
    protected datePickerService: DatePickerService,) {
    super(nav, title, router, cdRef, header, modal);
  }

  async fetchList(sort_key?: string): Promise<any> {
    this.requestHeaderParams['X-Sort'] = sort_key || '';
    this.isFetching = true;
    const res = await this.customSettingService.fetchCustomizeDefinitionDetails(
      this._searchParams,
      this.requestHeaderParams
    );
    const formatted = this._formatListData(res.result_data.customize_usage_definitions);
    this._fillLists(res.result_header, formatted);
    //this.customizeLists = res.result_data.customize_usage_definitions;
    this.isFetching = false;
  }

  protected async _fetchDataForInitialize(): Promise<any> {
    const res = await this.customSettingService.fetchCustomizeInitData();
    this.initialize(res);
    this.data["resource"] = res;
    this.labels = res.label;
    this.resource = res.resource;
    this._setTitle();
    this._updateFields(res.fields);
  }

  protected _formatListData(listBody: any[]): any {
    let result: any[] = [];
    listBody.forEach(element =>{
      (element.customize_usage_definition.customize_definitions as any[]).forEach(item => {
        result.push({
          "customize_usage_definitions.customize_usage_definition.customize_usage_definition_id": element.customize_usage_definition.customize_usage_definition_id,
          "customize_usage_definitions.customize_usage_definition.customize_usage_definition_name": element.customize_usage_definition.customize_usage_definition_name,
          "customize_usage_definitions.customize_usage_definition.customize_usage_definition_version": element.customize_usage_definition.customize_usage_definition_version,
          "customize_usage_definitions.customize_usage_definition.start_date": element.customize_usage_definition.start_date,
          "customize_usage_definitions.customize_usage_definition.end_date": element.customize_usage_definition.end_date,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.customize_definition_id": item.customize_definition_id,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.customize_definition_name": item.customize_definition_name,
          "customize_usage_definitions.customize_usage_definition.priority_name": item.priority_name,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.assumption_data_value": item.assumption_data_value,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.active_name": item.active_name,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.latest_operation_code_name": item.latest_operation_code_name,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.status_name": item.status_name,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.start_date": item.start_date,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.end_date": item.end_date,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.first_receive_datetime": item.first_receive_datetime,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.latest_receive_datetime": item.latest_receive_datetime,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.aggregation_condition_name": item.aggregation_condition_name,
          "customize_usage_definitions.customize_usage_definition.customize_definitions.send_condition_name": item.send_condition_name
        });
      })
    });
    return result;
  }

  /**
   * 指定項目取得 API の結果を反映
   * @param fields 指定項目
   */
   private _updateFields(fields: Fields) {
    this.fields = fields;
    this.thList = this._createThList(fields);
    const xFields = this._createXFields(fields);
    this.sortableThList = this.sortableThLists(this.thList);
    this._setXFields(xFields);
    const thLists = this._createThList(fields, { scrollable: true });
    this.fixedThList = thLists.fixed;
    this.scrollableThList = thLists.scrollable;
  }

  openNewDialog(){
    this.modalService.open(
      {
        title: this.labels.addition_title,
        labels: this.labels,
        content: this.csNewModalContent,
        closeBtnLabel: this.labels.cancel,
        okBtnLabel: this.labels.ok_btn,
        ok: () => {
          // TODO
          let customizeDefinitionVersion : any = this.newChildComponent.customizeDefinitionVersion as any;
          let isEnabled : any = this.newChildComponent.isEnabled as any;
          let priority : any = this.newChildComponent.priority as any;
          let responseData = {
            definition_version: (customizeDefinitionVersion.items as any[])
                                  .filter(i => i.id == customizeDefinitionVersion.itemParams.regist_customize_usage_definition_version)[0].name ,
            enabled: (isEnabled.items as any[]).filter(i => i.id == isEnabled.itemParams.regist_active_name)[0].name,
            priority: (priority.items as any[]).filter(i => i.id == priority.itemParams.regist_priority_name)[0].name
          }
          this.responseData = JSON.stringify(responseData);
        },
      },
      {
        size: 'lg',
      }
    );
  }

  openEditDialog(){
    // Setting input params before calling Modal - TODO
    this.inputParams.regist_customize_usage_definition_version = (this.resource.regist_customize_usage_definition_version.values as any[]).filter(element => element.name == this.versionInput)[0].value;
    this.inputParams.edit_start_date_ymd = this.startDateInput;
    this.inputParams.edit_end_date_ymd = this.endDateInput;
    this.inputParams.regist_active_name = (this.resource.regist_active_name.values as any[]).filter(element => element.name == this.enabledInput)[0].value;
    this.inputParams.regist_priority_name = (this.resource.regist_priority_name.values as any[]).filter(element => element.name == this.priorityInput)[0].value;
    this.inputParams.regist_customize_usage_definition_name = this.usageDefinitionName;
    this.inputParams.regist_customize_usage_definition_id = "1";

    this.modalService.open(
      {
        title: this.labels.edit_title,
        labels: this.labels,
        content: this.csEditModalContent,
        closeBtnLabel: this.labels.cancel,
        okBtnLabel: this.labels.ok_btn,
        ok: () => {
          // TODO
          let customizeDefinitionVersion : any = this.editChildComponent.customizeDefinitionVersion as any;
          let requetType : any = this.editChildComponent.requestType as any;
          let isEnabled : any = this.editChildComponent.isEnabled as any;
          let priority : any = this.editChildComponent.priority as any;
          let responseData = {
            definition_version: (customizeDefinitionVersion.items as any[])
                                  .filter(i => i.id == customizeDefinitionVersion.itemParams.regist_customize_usage_definition_version)[0].name ,
            requetType: (requetType.items as any[]).filter(i => i.id == requetType.itemParams.edit_customize_edit_kind)[0].name,
            enabled: (isEnabled.items as any[]).filter(i => i.id == isEnabled.itemParams.regist_active_name)[0].name,
            priority: (priority.items as any[]).filter(i => i.id == priority.itemParams.regist_priority_name)[0].name
          }
          this.responseData = JSON.stringify(responseData);
        },
      },
      {
        size: 'lg',
      }
    );
  }

  openGetRequestDialog(){
    this.modalService.open(
      {
        title: this.labels.confirmation_title,
        labels: this.labels,
        content: this.csGetRequestModalContent,
        closeBtnLabel: this.labels.cancel,
        okBtnLabel: this.labels.ok_btn,
        ok: () => {
          // TODO getting carId from the screen
          this.requestParams.cars[0].car_id = "2";
          this.customSettingService.postCustomUsageDefinitionRequest(this.requestParams)
          .then(res => {
            console.log("RES", res);
          })
        },
      },
      {
        size: 'lg',
      }
    );
  }

  openUpdateRequestConfirmDialog(){
    this.modalService.open(
      {
        title: this.labels.confirmation_title,
        labels: this.labels,
        content: this.csUpdateRequestConfirmModalContent,
        closeBtnLabel: this.labels.cancel,
        okBtnLabel: this.labels.ok_btn,
        ok: () => {
          // TODO
          let requestParams :{ car_id: string; request_route_kind: string; instant_kind: string; continuous_kind: string; customize_usage_definition: any[]} = {
            "car_id": "1",
            "request_route_kind": "1",
            "instant_kind": "1",
            "continuous_kind": "1",
            "customize_usage_definition" : []
          };
          this.updateRequestConfirm.lists.visibleList.forEach(element =>{
            requestParams.customize_usage_definition.push({
              "customize_usage_definition_id": element['customize_usage_definition.customize_usage_definition_id'],
              "version": element['customize_usage_definition.customize_usage_definition_version'],
              "request_kind": "2",
              "priority": element['customize_usage_definition.priority'],
              "date_to": element['customize_usage_definition.end_date'],
              "date_from": element['customize_usage_definition.start_date'],
              "active_kind": "1"
            })
          });
          this.customSettingService.postCustomUsageDefinitionUpdateRequest(requestParams)
          .then(res => {
            console.log("Update Res: ", res);
          })
        },
      },
      {
        size: 'lg',
      }
    );
  }
  
  openUpdateImmediateRequestConfirmDialog(){
    this.modalService.open(
      {
        title: this.labels.confirmation_title,
        labels: this.labels,
        content: this.csImmediateUpdateRequestModalContent,
        closeBtnLabel: this.labels.cancel,
        okBtnLabel: this.labels.ok_btn,
        ok: () => {
          // TODO
          let requestParams :{ car_id: string; request_route_kind: string; instant_kind: string; continuous_kind: string; customize_usage_definition: any[]} = {
            "car_id": "1",
            "request_route_kind": "1",
            "instant_kind": "1",
            "continuous_kind": this.csImmediateUpdateRequestConfirmComponent.isContinued,
            "customize_usage_definition" : []
          };
          this.csImmediateUpdateRequestConfirmComponent.lists.visibleList.forEach(element =>{
            requestParams.customize_usage_definition.push({
              "customize_usage_definition_id": element['customize_usage_definition.customize_usage_definition_id'],
              "version": element['customize_usage_definition.customize_usage_definition_version'],
              "request_kind": "2",
              "priority": element['customize_usage_definition.priority'],
              "date_to": element['customize_usage_definition.end_date'],
              "date_from": element['customize_usage_definition.start_date'],
              "active_kind": "1"
            })
          });
          this.customSettingService.postCustomUsageDefinitionUpdateRequest(requestParams)
          .then(res => {
            console.log("Update Res: ", res);
          })
        },
      },
      {
        size: 'lg',
      }
    );
  }
  
  openRequestResendConfirmDialog(){
    this.modalService.open(
      {
        title: this.labels.confirmation_title,
        labels: this.labels,
        content: this.csRequestResendConfirmModalContent,
        closeBtnLabel: this.labels.cancel,
        okBtnLabel: this.labels.ok_btn,
        ok: () => {
          // TODO
          let requestParams :{ car_id: string; customize_definition: any[]} = {
            "car_id": "1",
            "customize_definition" : []
          };
          this.csRequestResendConfirmComponent.lists.visibleList.forEach(element =>{
            requestParams.customize_definition.push({
              "customize_definition_id": element['customize_usage_definitions.customize_usage_definition.customize_usage_definition_id'],
            })
          });
          this.customSettingService.postCustomUsageDefinitionUpdateRequest(requestParams)
          .then(res => {
            console.log("Update Res: ", res);
          })
        },
      },
      {
        size: 'lg',
      }
    );
  }
}
