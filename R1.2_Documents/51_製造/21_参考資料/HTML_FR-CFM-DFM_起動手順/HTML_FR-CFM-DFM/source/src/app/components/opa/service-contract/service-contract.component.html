<section id="KBA-service-contract-index" *ngIf="labels && resource">
  <div class="container-fluid">
    <h2 class="KBA-user-index__title KBA-page-title">{{ labels.title }}</h2>
    <div class="KBA-content">
      <ng-container *ngIf="templateName === 'index'">
        <app-kba-file-upload
          [apiId]="uploadPath"
          [layout]="'index'"
          [labels]="labels"
          [uploadOnChange]="false"
          [collapsed]="true"
          [isLoading]="isLoading"
          [json]="uploadJSON"
          (uploadStart)="_showLoadingSpinner()"
          (uploadEnd)="onUploadEnd($event)"
          (uploadFail)="onUploadFail($event)"
        ></app-kba-file-upload>

        <app-kba-accordion
          [collapsed]="collapsed"
          [useCustomHeader]="false"
          [title]="labels.search_condition"
          [isLoading]="isLoading"
          [labels]="labels"
          (onChangeState)="changePanelState($event)"
        >
          <div data-kba-accordion-body class="panel-body">
            <div class="container KBA-search">
              <div class="row">
                <app-kba-selected
                  *ngIf="exists('block_id')"
                  class="col-sm-3"
                  [kbaName]="'block_id'"
                  [kbaParams]="_params"
                  [kbaResource]="resource"
                  [emitInitialRefresh]="false"
                  (onChangeSelectItem)="onBlockIdChange($event)"
                ></app-kba-selected>
                <app-kba-selected
                  #blockBelongingSelect
                  class="col-sm-3"
                  [kbaName]="'ids'"
                  [kbaParams]="_params.common.support_distributor"
                  [kbaResource]="resource.common.support_distributor"
                  [emitInitialRefresh]="false"
                  (onChangeSelectItem)="onSupportDistributorChange($event)"
                ></app-kba-selected>
                <app-kba-selected
                  #blockBelongingSelect
                  class="col-sm-3"
                  [kbaName]="'ids'"
                  [kbaParams]="_params.common.service_distributor"
                  [kbaResource]="resource.common.service_distributor"
                ></app-kba-selected>
                <app-kba-selected
                  #supportDBBelongingSelect
                  class="col-sm-3"
                  [kbaName]="'ids'"
                  [kbaParams]="_params.common.customer"
                  [kbaResource]="resource.common.customer"
                ></app-kba-selected>
              </div>
              <div class="row">
                <app-kba-selected
                  class="col-sm-3"
                  [kbaName]="'division_codes'"
                  [kbaParams]="_params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                ></app-kba-selected>
                <app-kba-selected
                  class="col-sm-3"
                  [kbaName]="'maker_codes'"
                  [kbaParams]="_params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                ></app-kba-selected>
              </div>
              <div class="row">
                <app-kba-text
                  class="col-sm-3"
                  [kbaName]="'models'"
                  [kbaParams]="_params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                  [maxlength]="20"
                ></app-kba-text>
                <app-kba-text
                  class="col-sm-3"
                  [kbaName]="'type_revs'"
                  [kbaParams]="_params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                  [maxlength]="15"
                ></app-kba-text>
                <app-kba-text
                  class="col-sm-3"
                  [kbaName]="'serials'"
                  [kbaParams]="_params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                ></app-kba-text>
              </div>
            </div>
            <div class="KBA-panel-footer">
              <button
                (click)="onClickSearch()"
                type="button"
                class="btn btn-primary search"
              >
                {{ labels.search }}
              </button>
              <button
                class="btn btn-warning download-template btn-download"
                type="button"
                (click)="onClickDownloadTemplate()"
              >
                {{ labels.download_template }}
                <i class="kba-icon kba-icon-download"></i>
              </button>
            </div>
          </div>
        </app-kba-accordion>

        <div class="KBA-table-options" [hidden]="count <= 0">
          <app-kba-pagination
            [count]="count"
            [params]="pageParams"
            [labels]="labels"
            [element]="pageCountEl"
            (changeState)="onPaginationChange()"
          ></app-kba-pagination>
          <div class="table-option-buttons">
            <div class="popover-wrapper">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="onClickFieldSelect($event)"
              >
                {{ labels.field_select }}
              </button>
              <app-kba-popover
                [labels]="labels"
                [resource]="fieldResources"
                [fields]="fields"
                [title]="labels.field_select"
                [(isVisible)]="fieldSelectPopoverVisible"
                (ok)="onFieldSelectOk($event)"
              ></app-kba-popover>
            </div>
            <button
              class="btn btn-primary"
              type="button"
              (click)="onClickServiceDBEdit()"
              [disabled]="selectedList.length === 0"
            >
              {{ labels.service_db_edit_btn }}
            </button>
          </div>
        </div>

        <div class="KBA-table-wrapper">
          <app-kba-table
            [selectable]="true"
            [selectedList]="selectedList"
            [checkedItems]="checkedItems"
            [lists]="lists"
            [pageParams]="pageParams"
            [params]="params"
            [sortingParams]="sortingParams"
            [fixedThList]="fixedThList"
            [scrollableThList]="scrollableThList"
            [sortableThList]="sortableThList"
            [labels]="labels"
            [collapsed]="collapsed"
            [isFetching]="isFetching"
            [checkIdName]="'car_identification.id'"
            (sort)="onChangeSort($event)"
          >
          </app-kba-table>
        </div>

        <ng-template #uploadResultModal> </ng-template>
      </ng-container>

      <ng-container *ngIf="templateName === 'edit'">
        <div class="KBA-form">
          <h3 class="block-header">{{ labels.service_db_edit_title }}</h3>
          <div class="service_db-all-edit-container">
            <div class="service_db-all-edit">
              <label class="service_db-all-edit-label">{{
                labels.service_db_all_edit
              }}</label>
              <div class="service_db-all-edit-selected">
                <app-kba-selected
                  #allEditSelect
                  [kbaName]="'service_distributor_id'"
                  [kbaParams]="{}"
                  [kbaResource]="resource.cars"
                  [showLabel]="false"
                  [hasEmpty]="true"
                  (onChangeSelectItem)="onSelectServiceIDAllEdit($event)"
                ></app-kba-selected>
              </div>
            </div>
          </div>

          <div class="KBA-table-wrapper edit-table table-auto-height">
            <table class="KBA-table table table-bordered">
              <thead class="KBA-table-thead">
                <tr class="KBA-table-flex-cell">
                  <ng-container *ngFor="let title of editThList">
                    <th
                      *ngIf="title.displayable"
                      class="th-{{ title.shortName }}"
                    >
                      <span>{{ title.label }}</span>
                    </th>
                  </ng-container>
                </tr>
              </thead>
              <tbody class="KBA-table-tbody" (scroll)="handleScroll()">
                <tr
                  *ngFor="let data of editList; let i = index"
                  class="KBA-table-flex-cell"
                >
                  <ng-container
                    *ngFor="let title of editThList"
                    [ngSwitch]="title.dataKey"
                  >
                    <ng-container *ngIf="title.displayable">
                      <td
                        *ngSwitchCase="'service_distributor.label'"
                        class="td-{{ title.shortName }} KBA-index-td select-{{
                          i
                        }} d-flex align-items-center"
                        [ngClass]="{
                          'select-invalid': isServiceDistributorInvalid(i)
                        }"
                      >
                        <app-kba-selected
                          #serviceDBSelect
                          [kbaName]="'service_distributor_id'"
                          [kbaParams]="editParams.cars[i]"
                          [kbaResource]="resource.cars"
                          [showLabel]="false"
                          [appendTo]="'body'"
                          (onChangeSelectItem)="
                            refreshEnglishLabel(data, $event)
                          "
                        ></app-kba-selected>
                      </td>
                      <td
                        *ngSwitchDefault
                        class="td-{{
                          title.shortName
                        }} KBA-index-td d-flex align-items-center"
                      >
                        <span>{{ data | at: title.dataKey }}</span>
                      </td>
                    </ng-container>
                  </ng-container>
                </tr>
              </tbody>
            </table>
          </div>

          <footer class="KBA-form-footer-fixed">
            <button
              class="btn btn-secondary"
              type="button"
              (click)="onClickBack()"
            >
              {{ labels.back }}
            </button>
            <button
              class="btn btn-primary"
              type="button"
              (click)="onClickSubmit()"
              [disabled]="!isEditValid"
            >
              {{ labels.submit }}
            </button>
          </footer>
        </div>
      </ng-container>
    </div>
  </div>

  <ng-template #confirmResultModalContent>
    <app-kba-simple-list-confirm
      [desc]="modalHeader"
      [val]="modalItems"
      [warningColumns]="'all'"
      [wideColumns]="wideColumns"
      [identifier]="modalIdentifier"
    ></app-kba-simple-list-confirm>
    <p class="result-count-message">{{ resultCountMessage }}</p>
  </ng-template>
</section>

<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
