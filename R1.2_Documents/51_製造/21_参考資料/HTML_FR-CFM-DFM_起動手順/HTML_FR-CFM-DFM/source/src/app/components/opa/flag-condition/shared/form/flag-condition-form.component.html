<section id="KBA-flag-condition-form" *ngIf="labels && resource">
  <div class="container-fluid" [hidden]="loading">
    <h2 class="KBA-page-title">{{ labels && labels.title }}</h2>

    <div
      class="KBA-content"
      *ngIf="params && params.flag_condition.flag_kind_code !== ''"
    >
      <form
        class="KBA-form"
        name="flagConditionForm"
        [formGroup]="flagConditionForm"
      >
        <div class="annotation">
          <p class="KBA-form-table__required">
            {{ labels && labels.description_for_required }}
          </p>
        </div>
        <table class="KBA-form-table table table-bordered" *ngIf="!loading">
          <tbody class="KBA-form-table-tbody">
            <tr
              app-kba-form-table-select
              *ngIf="exists('flag_condition.group_id')"
              class="KBA-form-row"
              [kbaName]="'group_id'"
              [kbaParams]="params.flag_condition"
              [kbaResource]="resource.flag_condition"
              [colspan]="3"
              [display]="'group_label'"
              [notEditable]="isUpdate"
            ></tr>
            <tr class="KBA-form-row">
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label require">{{
                  resource.flag_condition.flag_kind_code.name
                }}</label>
              </td>
              <td class="KBA-has-error" colspan="3">
                <div class="KBA-form-select-kind">
                  <ng-container *ngIf="!isUpdate">
                    <div class="kind kind-caution">
                      <input
                        name="flag_kind_code"
                        id="KBA-form-select-kind__kind-caution"
                        type="radio"
                        class="KBA-input-radio"
                        formControlName="flag_kind_code"
                        [value]="kind.caution"
                        [checked]="
                          params.flag_condition.flag_kind_code === kind.caution
                        "
                        (ngModelChange)="onSelectFlagKind($event)"
                      />
                      <label
                        for="KBA-form-select-kind__kind-caution"
                        class="KBA-input-radio__label"
                      >
                        {{
                          _getResourceValueName(
                            'flag_condition.flag_kind_code',
                            kind.caution
                          )
                        }}
                      </label>
                    </div>
                    <div class="kind kind-replacement-time">
                      <input
                        name="flag_kind_code"
                        id="KBA-form-select-kind__kind-replacement-time"
                        type="radio"
                        class="KBA-input-radio"
                        formControlName="flag_kind_code"
                        [value]="kind.replacementTime"
                        [checked]="
                          params.flag_condition.flag_kind_code ===
                          kind.replacementTime
                        "
                        (ngModelChange)="onSelectFlagKind($event)"
                      />
                      <label
                        for="KBA-form-select-kind__kind-replacement-time"
                        class="KBA-input-radio__label"
                      >
                        {{
                          _getResourceValueName(
                            'flag_condition.flag_kind_code',
                            kind.replacementTime
                          )
                        }}
                      </label>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="isUpdate">
                    <div class="kind">
                      <span
                        *ngIf="
                          params.flag_condition.flag_kind_code === kind.caution
                        "
                      >
                        {{
                          _getResourceValueName(
                            'flag_condition.flag_kind_code',
                            kind.caution
                          )
                        }}
                      </span>
                      <span
                        *ngIf="
                          params.flag_condition.flag_kind_code ===
                          kind.replacementTime
                        "
                      >
                        {{
                          _getResourceValueName(
                            'flag_condition.flag_kind_code',
                            kind.replacementTime
                          )
                        }}
                      </span>
                    </div>
                  </ng-container>
                </div>
              </td>
            </tr>
            <tr class="KBA-form-row">
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label require">{{
                  resource.flag_condition.flag_code.name
                }}</label>
              </td>
              <td class="KBA-has-error" colspan="3">
                <div class="KBA-form-select-code">
                  <div
                    class="code code-red-flag"
                    *ngIf="!isSelectedKindCaution()"
                  >
                    <input
                      name="flag_code"
                      id="KBA-form-select-code__code-red-flag"
                      type="radio"
                      class="KBA-input-radio"
                      formControlName="flag_code"
                      [value]="flagCode.red"
                      [checked]="
                        params.flag_condition.flag_code === flagCode.red
                      "
                      (ngModelChange)="onSelectFlagCode($event)"
                    />
                    <label
                      for="KBA-form-select-code__code-red-flag"
                      class="KBA-input-radio__label"
                    >
                      <i
                        class="fa fa-flag kba-flag"
                        [ngClass]="'flag-type-' + flagCode.red"
                      ></i>
                    </label>
                  </div>
                  <div class="code code-yellow-flag">
                    <input
                      name="flag_code"
                      id="KBA-form-select-code__code-yellow-flag"
                      type="radio"
                      class="KBA-input-radio"
                      formControlName="flag_code"
                      [value]="flagCode.yellow"
                      [checked]="
                        params.flag_condition.flag_code === flagCode.yellow
                      "
                      (ngModelChange)="onSelectFlagCode($event)"
                    />
                    <label
                      for="KBA-form-select-code__code-yellow-flag"
                      class="KBA-input-radio__label"
                    >
                      <i
                        class="fa fa-flag kba-flag"
                        [ngClass]="'flag-type-' + flagCode.yellow"
                      ></i>
                    </label>
                  </div>
                </div>
              </td>
            </tr>
            <ng-container *ngIf="isSelectedKindCaution()">
              <tr
                class="KBA-form-row"
                *ngIf="exists('flag_condition.event_condition.event_code')"
              >
                <td class="KBA-form-table__head">
                  <label class="KBA-form-table__label KBA-form-table__required">
                    {{
                      resource.flag_condition.event_condition.event_code.name
                    }}
                  </label>
                </td>
                <td colspan="3">
                  <div class="form-group KBA-input__small caution-icon">
                    <i
                      class="kba-caution-icon kba-caution-icon_{{
                        iconFont(
                          params
                            | at: 'flag_condition.event_condition.event_code'
                        )
                      }}"
                    ></i>
                    <app-kba-selected
                      [kbaName]="'event_code'"
                      [kbaParams]="params.flag_condition.event_condition"
                      [kbaResource]="resource.flag_condition.event_condition"
                      [showLabel]="false"
                      (onChangeSelectItem)="onEventCodeChange($event)"
                    >
                    </app-kba-selected>
                  </div>
                </td>
              </tr>
              <ng-container
                *ngFor="let type of fillEvaluationCodes(); let i = index"
              >
                <tr class="KBA-form-row">
                  <td class="KBA-form-table__head" rowspan="2" *ngIf="i === 0">
                    <label
                      class="KBA-form-table__label KBA-form-table__required"
                    >
                      {{
                        resource.flag_condition.event_condition
                          .detection_condition_code.name
                      }}
                    </label>
                  </td>
                  <td class="vertical-align-baseline">
                    <div
                      class="input-group"
                      [formGroup]="flagConditionForm.controls.cautionGroup"
                    >
                      <input
                        name="detection_condition_code"
                        id="KBA-flag-type-{{ type.value }}"
                        type="radio"
                        class="KBA-input-radio"
                        checked="params.flag_condition.event_condition.detection_condition_code"
                        [value]="type.value"
                        formControlName="detection_condition_code"
                        (ngModelChange)="onEvaluationCodeChange($event)"
                      />
                      <label
                        class="KBA-input-radio__label"
                        for="KBA-flag-type-{{ type.value }}"
                        >{{ type.name }}</label
                      >
                    </div>
                  </td>
                  <ng-container
                    *ngTemplateOutlet="detectionConditionCodeContent"
                  ></ng-container>
                  <ng-template #detectionConditionCodeContent>
                    <ng-container [ngSwitch]="type.value">
                      <ng-container
                        *ngSwitchCase="
                          detectionConditionCode.consecutive_occurrence_days
                        "
                      >
                        <td class="vertical-align-baseline">
                          <div
                            class="KBA-form-date input-group"
                            [formGroup]="
                              flagConditionForm.controls.cautionGroup
                            "
                          >
                            <label class="input-group-addon">
                              {{
                                resource.flag_condition.event_condition
                                  .occurrence_identification
                                  .consecutive_occurrence_days.name
                              }}
                            </label>
                            <input
                              type="text" autocomplete="off"
                              class="KBA-input-text form-control"
                              name="consecutive_occurrence_days"
                              maxlength="2"
                              required="true"
                              (ngModelChange)="
                                params.flag_condition.event_condition
                                  .occurrence_identification
                                  .consecutive_occurrence_days = $event
                              "
                              formControlName="consecutive_occurrence_days"
                              [ngClass]="{
                                'KBA-form-error':
                                  errorData
                                  | hasError
                                    : 'flag_condition.event_condition.occurrence_identification.consecutive_occurrence_days'
                              }"
                            />
                            <span class="unit">{{ labels.day_unit }}</span>
                          </div>
                        </td>
                      </ng-container>
                      <ng-container
                        *ngSwitchCase="detectionConditionCode.decision_period"
                      >
                        <td class="vertical-align-baseline">
                          <div
                            class="KBA-form-date input-group"
                            [formGroup]="
                              flagConditionForm.controls.cautionGroup.controls
                                .decisionPeriodGroup
                            "
                          >
                            <label class="input-group-addon">
                              {{
                                resource.flag_condition.event_condition
                                  .occurrence_identification.occurrence_days
                                  .name
                              }}
                            </label>
                            <input
                              type="text" autocomplete="off"
                              class="KBA-input-text form-control"
                              name="occurrence_days"
                              maxlength="2"
                              required="true"
                              (ngModelChange)="
                                params.flag_condition.event_condition
                                  .occurrence_identification.occurrence_days = $event
                              "
                              formControlName="occurrence_days"
                              [ngClass]="{
                                'KBA-form-error':
                                  errorData
                                  | hasError
                                    : 'flag_condition.event_condition.occurrence_identification.occurrence_days'
                              }"
                            />
                            <span class="unit">{{ labels.day_unit }}</span>
                          </div>
                        </td>
                        <td class="vertical-align-baseline">
                          <div
                            class="KBA-form-date input-group"
                            [formGroup]="
                              flagConditionForm.controls.cautionGroup.controls
                                .decisionPeriodGroup
                            "
                          >
                            <label class="input-group-addon">
                              {{
                                resource.flag_condition.event_condition
                                  .occurrence_identification.decision_period
                                  .name
                              }}
                            </label>
                            <input
                              type="text" autocomplete="off"
                              class="KBA-input-text form-control"
                              name="decision_period"
                              maxlength="2"
                              required="true"
                              (ngModelChange)="
                                params.flag_condition.event_condition
                                  .occurrence_identification.decision_period = $event
                              "
                              formControlName="decision_period"
                              [ngClass]="{
                                'KBA-form-error':
                                  errorData
                                  | hasError
                                    : 'flag_condition.event_condition.occurrence_identification.decision_period'
                              }"
                            />
                            <span class="unit">{{ labels.day_unit }}</span>
                          </div>
                        </td>
                      </ng-container>
                    </ng-container>
                  </ng-template>
                </tr>
              </ng-container>
              <tr class="KBA-form-row">
                <td class="KBA-form-table__head">
                  <label class="KBA-form-table__label">{{
                    resource.flag_condition.event_condition
                      .occurrence_identification.min_alerm_time.name
                  }}</label>
                </td>
                <td colspan="3">
                  <div
                    class="form-group"
                    [formGroup]="flagConditionForm.get('cautionGroup')"
                  >
                    <div class="checkbox-inline">
                      <input
                        type="checkbox"
                        name="minimum_duration"
                        id="KBA-options-minimumーduration"
                        class="KBA-input-checkbox checkbox-with-label"
                        [checked]="minimum_duration"
                        (ngModelChange)="onCheckedMininumDuration($event)"
                        formControlName="minimum_duration"
                      />
                      <label
                        for="KBA-options-minimumーduration"
                        class="KBA-input-checkbox__label"
                      >
                        {{ resource.flag_condition.minimum_duration.name }}
                      </label>
                    </div>
                    <div class="form-group KBA-input__middle min_alerm_time">
                      <div
                        class="min_alerm_time_content"
                        [formGroup]="flagConditionForm.get('cautionGroup')"
                      >
                        <input
                          type="text" autocomplete="off"
                          name="min_alerm_time"
                          formControlName="min_alerm_time"
                          (ngModelChange)="
                            params.flag_condition.event_condition
                              .occurrence_identification.min_alerm_time = $event
                          "
                          maxlength="3"
                          required="{{ minimum_duration }}"
                          class="KBA-input-text form-control"
                          [ngClass]="{
                            'KBA-form-error':
                              errorData
                              | hasError
                                : 'flag_condition.event_condition.occurrence_identification.min_alerm_time'
                          }"
                        />
                        <p>
                          {{ labels.minute }}
                        </p>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
            <ng-container *ngIf="!isSelectedKindCaution()">
              <tr
                class="KBA-form-row"
                *ngIf="
                  exists(
                    'flag_condition.event_condition.time_identification.remaining_time_threshold'
                  )
                "
              >
                <td class="KBA-form-table__head">
                  <label class="KBA-form-table__label KBA-form-table__required">
                    {{
                      resource.flag_condition.event_condition
                        .time_identification.remaining_time_threshold.name
                    }}
                  </label>
                </td>
                <td colspan="3">
                  <div class="form-group">
                    <div
                      class="form-group KBA-input__middle remaining_time_threshold"
                    >
                      <div
                        class="remaining_time_threshold_content"
                        [formGroup]="
                          flagConditionForm.get('replacementTimeGroup')
                        "
                      >
                        <input
                          type="text" autocomplete="off"
                          name="remaining_time_threshold"
                          formControlName="remaining_time_threshold"
                          (ngModelChange)="
                            params.flag_condition.event_condition
                              .time_identification.remaining_time_threshold = $event
                          "
                          maxlength="6"
                          required="true"
                          class="KBA-input-text form-control"
                          [ngClass]="{
                            'KBA-form-error':
                              errorData
                              | hasError
                                : 'flag_condition.event_condition.time_identification.remaining_time_threshold'
                          }"
                        />
                        <p>
                          {{ labels.hour }}
                        </p>
                      </div>
                    </div>
                    <div class="attention-word">
                      {{ labels && labels.remaining_time_threshold_attention }}
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
            <tr
              app-kba-form-table-textarea
              class="KBA-form-row"
              [formGroup]="flagConditionForm"
              [kbaName]="'free_memo'"
              [kbaParams]="params.flag_condition"
              [kbaResource]="resource.flag_condition"
              [kbaLabel]="labels"
              [colspan]="3"
              [maxLength]="2048"
              [path]="'flag_condition.free_memo'"
              [errorData]="errorData"
            ></tr>
          </tbody>
        </table>

        <footer class="KBA-form-footer-fixed">
          <a
            href="javascript:void(0)"
            (click)="onClickReset()"
            class="btn btn-link"
          >
            {{ labels && labels.reset }}
          </a>
          <button
            class="btn btn-success"
            type="button"
            *ngIf="!isUpdate"
            (click)="onClickContinue()"
            [disabled]="flagConditionForm.controls[formGroupName].invalid"
          >
            {{ labels && labels.continue }}
          </button>
          <button
            class="btn btn-primary"
            type="button"
            (click)="onClickSubmit()"
            [disabled]="flagConditionForm.controls[formGroupName].invalid"
          >
            {{ labels && labels.submit }}
          </button>
        </footer>
      </form>
    </div>
  </div>

  <ng-template #submitModalContent>
    <app-kba-tandem-confirm
      class="confirm-modal-content"
      [desc]="desc"
      [val]="val"
      [customContent]="submitModalCustomContent"
    ></app-kba-tandem-confirm>
  </ng-template>

  <ng-template #submitModalCustomContent let-d="d" let-value="value">
    <ng-container [ngSwitch]="d.name">
      <p *ngSwitchCase="'flag_condition.flag'">
        <i
          class="fa fa-flag kba-flag"
          [ngClass]="'flag-type-' + params.flag_condition.flag_code"
        ></i>
      </p>
      <ng-container *ngSwitchCase="'flag_condition'">
        <p *ngFor="let condition of value" class="wrap">
          {{ condition.name }} : {{ condition.value }}
        </p>
      </ng-container>
      <ng-container *ngSwitchCase="'flag_condition.free_memo'">
        <p class="free_memo">{{ value }}</p>
      </ng-container>
      <p *ngSwitchDefault>{{ value }}</p>
    </ng-container>
  </ng-template>

  <ng-template #resetModalContent>
    <p class="KBA-modal-message">{{ labels.reset_modal_body }}</p>
  </ng-template>
</section>

<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
