<section id="KBA-group-area-car-index" *ngIf="labels && resource">
  <form class="KBA-form" #f="ngForm">
    <div class="container-fluid">
      <h2 class="KBA-group-area-index__title KBA-page-title">
        {{ labels.title }}
      </h2>

      <div class="KBA-content">
        <!-- 検索 -->
        <app-kba-accordion
          [collapsed]="collapsed"
          [useCustomHeader]="false"
          [title]="labels.search_condition"
          [labels]="labels"
          (onChangeState)="changePanelState($event)"
        >
          <div data-kba-accordion-body>
            <div class="container KBA-search">
              <app-kba-car-search
                [activeTab]="activeTab"
                [modelCarTypeCheck]="modelCarTypeCheck"
                [labels]="labels"
                [resource]="resource"
                [params]="params"
                (changeModelCarTypeCheck)="onChangeModelCarTypeCheck()"
                (changeSupportDistributor)="onChangeSupportDistributor($event)"
                (changeSupportDbOrgCode)="onChangeSupportDbOrgCode($event)"
                (changeServiceDb)="onChangeServiceDb($event)"
                (changeServiceDbOrgCode)="onChangeServiceDbOrgCode($event)"
              >
              </app-kba-car-search>
            </div>
            <div class="KBA-panel-footer">
              <a
                href="javascript:void(0)"
                (click)="onClickReset()"
                class="btn btn-link"
              >
                {{ labels.reset }}
              </a>
              <button
                (click)="onClickSearch()"
                type="button"
                class="btn btn-primary search"
              >
                {{ labels.search }}
              </button>
            </div>
          </div>
        </app-kba-accordion>

        <!-- 検索条件一覧 -->
        <app-kba-accordion
          [collapsed]="listCollapsed"
          [useCustomHeader]="false"
          [title]="labels.search_condition_list"
          [labels]="labels"
          (onChangeState)="changeListPanelState($event)"
        >
          <div data-kba-accordion-body>
            <app-kba-search-conditions
              [params]="params"
              [resource]="resource"
              [pageCount]="pageParams.pageCount"
              [selectorKeys]="selectorKeys"
              [selectedParams]="getSelectedParams()"
              [modelCarTypeCheck]="modelCarTypeCheck"
            >
            </app-kba-search-conditions>
          </div>
        </app-kba-accordion>

        <!-- ページネーション -->
        <div class="KBA-table-options" [hidden]="count <= 0">
          <app-kba-pagination
            [count]="count"
            [params]="pageParams"
            [labels]="labels"
            [element]="pageCountEl"
            (changeState)="onPaginationChange()"
          >
          </app-kba-pagination>
          <div class="table-option-buttons">
            <div class="popover-wrapper">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="onClickFieldSelect($event)"
              >
                {{ labels.field_select }}
              </button>
              <app-kba-popover
                [labels]="labels"
                [resource]="fieldResources"
                [fields]="fields"
                [title]="labels.field_select_title"
                [(isVisible)]="fieldSelectPopoverVisible"
                [promise]="fieldResourcesPromise"
                (ok)="onFieldSelectOk($event)"
              >
              </app-kba-popover>
            </div>
          </div>
        </div>

        <!-- 一覧 -->
        <app-kba-table
          [customFixedTableThContent]="customFixedTableThContent"
          [customFixedTableRowContent]="customFixedTableRowContent"
          [customTableRowContent]="customTableRowContent"
          thClass="two-layers"
          [labels]="labels"
          [collapsed]="collapsed"
          [lists]="lists"
          [pageParams]="pageParams"
          [fixedThList]="unitedFixedThList"
          [scrollableThList]="scrollableThList"
          [(sortingParams)]="sortingParams"
          [sortableThList]="sortableThList"
          [updatable]="updatable"
          [isFetching]="isFetching"
          [multiLineColumns]="multiLineColumns"
          [hiddenItemStyles]="hiddenItemStyles"
          (edit)="onClickEdit($event)"
          (sort)="onChangeSort($event)"
        >
          <ng-template #customFixedTableThContent let-data="data">
            <ng-container *ngFor="let th of unitedFixedThList; let i = index">
              <ng-container *ngIf="th.displayable">
                <!-- エリアの場合 -->
                <th
                  *ngIf="th.name === 'area'"
                  class="KBA-cell-space KBA-index-th th-area"
                  [colSpan]="th.unitedTh.length"
                >
                  <span
                    [ngClass]="'th-area-sort-' + i"
                    appKbaSortingLabel
                    [(sortingParams)]="sortingParams"
                    [labelName]="th.unitedTh[1].name"
                    [sortableThList]="sortableThList"
                    (sort)="onChangeSort($event)"
                  >
                    {{ th.label }}
                  </span>
                  <ul>
                    <li
                      *ngFor="let uTh of th.unitedTh"
                      class="th-{{ uTh.shortName }}"
                    >
                      <span>
                        {{ uTh.label }}
                      </span>
                    </li>
                  </ul>
                </th>

                <!-- MAPの場合 -->
                <th *ngIf="th.name === 'header_map'" class="KBA-index-th fixed">
                  {{ th.label }}
                </th>

                <!-- 上記以外の td の場合 -->
                <th
                  *ngIf="th.name !== 'header_map' && th.name !== 'area'"
                  class="th-{{ th.shortName }} KBA-index-th"
                  [ngClass]="{ 'disable-sort': !th.sortable }"
                  appKbaSortingLabel
                  [(sortingParams)]="sortingParams"
                  [labelName]="th.name"
                  [sortableThList]="sortableThList"
                  (sort)="onChangeSort($event)"
                >
                  {{ th.label }}
                </th>
              </ng-container>
            </ng-container>
          </ng-template>

          <ng-template #customFixedTableRowContent let-data="data">
            <ng-container *ngFor="let title of fixedThList">
              <ng-container *ngIf="title.displayable">
                <!-- MAPの場合 -->
                <ng-container *ngIf="title.name === 'header_map'">
                  <td
                    *ngIf="!mapIconHidden(data)"
                    class="KBA-index-td KBA-table__small kba-sm-link text-center fixed"
                    (click)="onClickMap(data)"
                  >
                    <span class="kba-icon kba-icon-map"></span>
                  </td>
                  <td
                    *ngIf="mapIconHidden(data)"
                    class="KBA-index-td KBA-table__small text-center fixed"
                  >-</td>
                </ng-container>

                <!-- 上記以外の td の場合 -->
                <td
                  *ngIf="title.name !== 'header_map'"
                  class="td-{{ title.shortName }} KBA-index-td"
                >
                  {{ data[title.name] }}
                </td>
              </ng-container>
            </ng-container>
          </ng-template>

          <ng-template #customTableRowContent let-data="data">
            <ng-container *ngFor="let title of scrollableThList">
              <td
                *ngIf="title.displayable"
                class="td-{{ title.shortName }} KBA-index-td"
              >
                {{ data[title.name] }}
              </td>
            </ng-container>
          </ng-template>
        </app-kba-table>
      </div>
    </div>
  </form>
</section>

<ng-template #mapModalContent>
  <div class="KBA-map">
    <ul class="KBA-toggle-buttons">
      <li *ngFor="let menuItem of areaMenu">
        <button
          class="btn KBA-toggle-button__on"
          type="button"
          [ngClass]="{ 'KBA-toggle-button__on': isCurrent(menuItem.no) }"
          (click)="onChangeArea(menuItem)"
        >
          {{ menuItem.label }}
        </button>
      </li>
    </ul>
    <div class="area-map">
      <app-kba-area-menu
        [initMap]="{}"
        [menuOpen]="menuOpen"
        [isCurrent]="true"
        [labels]="labels"
        [editable]="false"
        [polyPoints]="currentMenuItem.polyPoints"
        [rectData]="currentMenuItem.rectData"
        [selectType]="currentMenuItem.selectType"
        [selectTypeLabel]="currentMenuItem.selectTypeLabel"
        (changeMenuOpen)="menuOpen = $event"
      >
      </app-kba-area-menu>
      <app-kba-area-map
        #areaMapComponent
        [initMap]="{}"
        [no]="currentMenuItem.no"
        [labels]="labels"
        [others]="others"
        [menuWidth]="312"
        [menuOpen]="menuOpen"
        [isModal]="true"
        [selectType]="currentMenuItem.selectType"
        [polyPoints]="currentMenuItem.polyPoints"
        [rectData]="currentMenuItem.rectData"
        [editable]="false"
      >
      </app-kba-area-map>
    </div>
  </div>
</ng-template>

<ng-template #resetModalContent>
  <p class="KBA-modal-message">{{ labels.reset_modal_body }}</p>
</ng-template>

<app-kba-alert></app-kba-alert>

<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
