<section id="KBA-flag-index" *ngIf="labels && resource">
  <div class="container-fluid">
    <h2 class="KBA-contact-index__title KBA-page-title">{{ labels.title }}</h2>
    <div class="KBA-content">
      <app-kba-accordion
        *ngIf="resource.support_distributor_id"
        [collapsed]="collapsed"
        [useCustomHeader]="false"
        [title]="labels.search_condition"
        [isLoading]="isLoading"
        [labels]="labels"
        (onChangeState)="changePanelState($event)"
      >
        <div data-kba-accordion-body>
          <div class="container KBA-search">
            <div class="row">
              <app-kba-selected
                class="col-sm-3"
                [kbaName]="'support_distributor_id'"
                [kbaParams]="params"
                [kbaResource]="resource"
              >
              </app-kba-selected>
            </div>
          </div>
          <div class="KBA-panel-footer">
            <button
              (click)="onClickSearch()"
              type="button"
              class="btn btn-primary search"
            >
              {{ labels.search }}
            </button>
          </div>
        </div>
      </app-kba-accordion>

      <div class="KBA-table-options" [hidden]="count <= 0">
        <app-kba-pagination
          [count]="count"
          [params]="pageParams"
          [labels]="labels"
          [element]="pageCountEl"
          (changeState)="onPaginationChange()"
        ></app-kba-pagination>
        <div class="table-option-buttons">
          <div class="popover-wrapper">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="onClickFieldSelect($event)"
            >
              {{ labels.field_select }}
            </button>
            <app-kba-popover
              [labels]="labels"
              [resource]="fieldResources"
              [fields]="fields"
              [title]="labels.field_select_title"
              [(isVisible)]="fieldSelectPopoverVisible"
              (ok)="onFieldSelectOk($event)"
            ></app-kba-popover>
          </div>
          <div class="popover-wrapper">
            <button
              type="button"
              class="btn btn-warning"
              (click)="onClickDownloadAll($event)"
            >
              {{ labels.download_all }}
              <i class="kba-icon kba-icon-download"></i>
            </button>
            <app-kba-popover
              [labels]="labels"
              [resource]="downloadFieldResources"
              [fields]="downloadFields"
              [title]="labels.download_select_title"
              [(isVisible)]="downloadPopoverVisible"
              [download]="true"
              [downloadType]="resource.file_content_type"
              (ok)="onDownloadOk($event)"
            ></app-kba-popover>
          </div>
        </div>
      </div>

      <app-kba-table
        [customTableThContent]="customTableThContent"
        [customTableRowContent]="customTableRowContent"
        [lists]="lists"
        [pageParams]="pageParams"
        [sortingParams]="sortingParams"
        [thList]="thList"
        [sortableThList]="sortableThList"
        [labels]="labels"
        [collapsed]="collapsed"
        [updatable]="updatable"
        [deletable]="deletable"
        [detailedly]="true"
        [isFetching]="isFetching"
        (detail)="onClickDetail($event)"
        (delete)="onClickDelete($event)"
        (edit)="onClickEdit($event)"
        (sort)="onChangeSort($event)"
      >
      </app-kba-table>
    </div>
  </div>

  <ng-template #customTableThContent>
    <ng-container *ngFor="let th of thList">
      <th
        *ngIf="th.displayable"
        class="KBA-index-th th-{{ th.shortName }}"
        [ngClass]="{
          fixed: th.dataKey === 'flag_code',
          'disable-sort': !th.sortable
        }"
        appKbaSortingLabel
        [(sortingParams)]="sortingParams"
        [labelName]="th.sortKey"
        [sortableThList]="sortableThList"
        (sort)="onChangeSort($event)"
      >
        <span>{{ th.label }}</span>
      </th>
    </ng-container>
  </ng-template>

  <ng-template #customTableRowContent let-data="data">
    <ng-container *ngFor="let title of thList">
      <ng-container [ngSwitch]="title.dataKey" *ngIf="title.displayable">
        <td
          *ngSwitchCase="'flag_code'"
          class="fixed td-{{
            title.shortName
          }} d-flex align-items-center justify-content-center"
        >
          <i
            class="fa fa-flag kba-flag"
            [ngClass]="'flag-type-' + (data | at: title.dataKey)"
          ></i>
        </td>
        <td
          *ngSwitchCase="
            'event_condition.occurrence_identification.ignore_0minute_code'
          "
          class="td-{{
            title.shortName
          }} d-flex align-items-center justify-content-center"
        >
          <i class="fa fa-check" *ngIf="(data | at: title.dataKey) === '1'"></i>
        </td>
        <td
          *ngSwitchDefault
          class="td-{{ title.shortName }} d-flex align-items-center"
        >
          <span>{{ data | at: title.dataKey }}</span>
        </td>
      </ng-container>
    </ng-container>
  </ng-template>

  <ng-template #detailDeleteModalContent>
    <table class="KBA-form-table table table-bordered">
      <tbody class="KBA-form-table-tbody">
        <ng-container *ngFor="let d of desc">
          <ng-container [ngSwitch]="d.dataKey" *ngIf="d.displayable">
            <ng-container *ngSwitchCase="'flag_code'">
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label">{{ d.label }}</label>
              </td>
              <td class="KBA-form-table__value" colspan="2" *ngIf="val">
                <i
                  class="fa fa-flag kba-flag"
                  [ngClass]="'flag-type-' + val.flag_code"
                ></i>
              </td>
            </ng-container>

            <ng-container
              *ngSwitchCase="
                'event_condition.occurrence_identification.ignore_0minute_code'
              "
            >
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label">{{ d.label }}</label>
              </td>
              <td class="KBA-form-table__value" colspan="2" *ngIf="val">
                <i
                  class="fa fa-check"
                  *ngIf="
                    val.event_condition.occurrence_identification
                      .ignore_0minute_code === '1'
                  "
                ></i>
              </td>
            </ng-container>

            <ng-container *ngSwitchCase="'car_conditions.model'">
              <ng-container *ngIf="val && divisionsForDisplay.length > 0">
                <tr *ngFor="let division of divisionsForDisplay; let i = index">
                  <td
                    class="KBA-form-table__head"
                    [attr.rowspan]="divisionsForDisplay.length"
                    *ngIf="i === 0"
                  >
                    <label class="KBA-form-table__label">{{ d.label }}</label>
                  </td>
                  <td class="KBA-model-cell">{{ division.model }}</td>
                  <td class="KBA-rev-cell">
                    <span
                      class="KBA-rev-cell_value"
                      *ngFor="let d of division.divisions"
                      >{{ d.type_rev }}</span
                    >
                  </td>
                </tr>
              </ng-container>
              <ng-container *ngIf="val && divisionsForDisplay.length === 0">
                <tr>
                  <td class="KBA-form-table__head">
                    <label class="KBA-form-table__label">{{ d.label }}</label>
                  </td>
                  <td class="KBA-form-table__value" colspan="2">
                    <p>{{ labels.all_models }}</p>
                  </td>
                </tr>
              </ng-container>
            </ng-container>

            <ng-container *ngSwitchCase="'free_memo'">
              <tr>
                <td class="KBA-form-table__head">
                  <label class="KBA-form-table__label">{{ d.label }}</label>
                </td>
                <td class="KBA-form-table__value" colspan="2">
                  <p class="free-memo">{{ val | at: d.dataKey }}</p>
                </td>
              </tr>
            </ng-container>

            <ng-container *ngSwitchDefault>
              <tr>
                <td class="KBA-form-table__head">
                  <label class="KBA-form-table__label">{{ d.label }}</label>
                </td>
                <td class="KBA-form-table__value" colspan="2">
                  <p>{{ val | at: d.dataKey }}</p>
                </td>
              </tr>
            </ng-container>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </ng-template>
</section>
<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
