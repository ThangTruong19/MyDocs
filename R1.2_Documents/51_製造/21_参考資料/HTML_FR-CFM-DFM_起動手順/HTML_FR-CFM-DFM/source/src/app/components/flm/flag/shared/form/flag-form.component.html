<section id="KBA-contact-form" *ngIf="labels && resource">
  <div class="container-fluid" [hidden]="isLoading">
    <h2 class="KBA-page-title">{{ labels.title }}</h2>

    <div class="KBA-content" *ngIf="params && resource.division_code">
      <form class="KBA-form" name="flagForm" novalidate>
        <p class="KBA-form-table__required">
          {{ labels.description_for_required }}
        </p>
        <table class="KBA-form-table table table-bordered" *ngIf="!isLoading">
          <tbody class="KBA-form-table-tbody" [formGroup]="flagForm">
            <tr
              app-kba-form-table-select
              *ngIf="(resource | at: 'flag_condition.support_distributor_id') && !isUpdate"
              class="KBA-form-row"
              [kbaName]="'support_distributor_id'"
              [kbaParams]="params.flag_condition"
              [kbaResource]="resource.flag_condition"
              [colspan]="3"
              [emitInitialRefresh]="false"
              (onChange)="handleSupportDistributorChange($event)"
            ></tr>
            <tr *ngIf="(resource | at: 'flag_condition.support_distributor_id') && isUpdate" class="KBA-form-row">
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label">
                  {{ labels.support_distributor_label }}
                </label>
              </td>
              <td colspan="3">
                <p>{{ supportDistributorLabel }}</p>
              </td>
            </tr>
            <tr class="KBA-form-row" *ngIf="exists('flag_condition.flag_code')">
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label">{{
                  resource.flag_condition.flag_code.name
                }}</label>
              </td>
              <td colspan="3">
                <ng-container
                  *ngFor="
                    let flag of (resource | at: 'flag_condition.flag_code')
                      .values
                  "
                >
                  <input
                    name="flag-type"
                    id="flag-type-{{ flag.value }}"
                    type="radio"
                    class="KBA-input-radio"
                    [value]="flag.value"
                    [(ngModel)]="params.flag_condition.flag_code"
                    [ngModelOptions]="{ standalone: true }"
                  />
                  <label
                    for="{{ 'flag-type-' + flag.value }}"
                    class="KBA-input-radio__label"
                  >
                    <i
                      class="fa fa-flag kba-flag"
                      [ngClass]="'flag-type-' + flag.value"
                    ></i>
                  </label>
                </ng-container>
              </td>
            </tr>
            <tr
              app-kba-form-table-text
              class="KBA-form-row"
              [formGroup]="flagForm"
              [kbaName]="'event_code'"
              [kbaParams]="params.flag_condition.event_condition"
              [kbaResource]="resource.flag_condition.event_condition"
              [kbaLabel]="labels"
              [colspan]="3"
              [required]="true"
              [maxLength]="6"
              [size]="'small'"
              [path]="'flag_condition.event_condition.event_code'"
              [errorData]="errorData"
            ></tr>
            <tr class="KBA-form-row">
              <td
                class="KBA-form-table__head"
                [attr.rowspan]="allModels ? 2 : divisionsForDisplay.length + 1"
              >
                <label class="KBA-form-table__label KBA-form-table__required">{{
                  (resource | at: 'flag_condition.car_conditions').name
                }}</label>
              </td>
              <td colspan="3">
                <button
                  type="button"
                  class="btn btn-secondary"
                  (click)="showModelRevModal()"
                >
                  {{ labels.select }}
                </button>
              </td>
            </tr>
            <ng-container *ngTemplateOutlet="modelRevDisplay"></ng-container>
            <tr class="KBA-form-row">
              <td class="KBA-form-table__head" rowspan="4">
                <label class="KBA-form-table__label KBA-form-table__required">{{
                  (
                    resource
                    | at
                      : 'flag_condition.event_condition.detection_condition_code'
                  ).name
                }}</label>
              </td>
            </tr>
            <ng-container
              *ngFor="
                let type of (
                  resource
                  | at
                    : 'flag_condition.event_condition.detection_condition_code'
                ).values
              "
            >
              <tr class="KBA-form-row">
                <td>
                  <div class="input-group">
                    <input
                      name="detection_condition_code"
                      id="KBA-flag-type-{{ type.value }}"
                      type="radio"
                      class="KBA-input-radio"
                      [value]="type.value"
                      formControlName="detection_condition_code"
                      (ngModelChange)="onEvaluationCodeChange($event)"
                    />
                    <label
                      class="KBA-input-radio__label"
                      for="KBA-flag-type-{{ type.value }}"
                      >{{ type.name }}</label
                    >
                  </div>
                </td>
                <ng-container
                  *ngTemplateOutlet="evaluationCodeContent"
                ></ng-container>
                <ng-template #evaluationCodeContent>
                  <ng-container [ngSwitch]="type.value">
                    <ng-container
                      *ngSwitchCase="evaluationCode.consecutiveOccurrenceDays"
                      [formGroup]="
                        flagForm.get(
                          'conditions.consecutiveOccurrenceDaysGroup'
                        )
                      "
                    >
                      <td class="vertical-align-top">
                        <div class="KBA-form-date input-group">
                          <label class="input-group-addon">
                            {{
                              (
                                resource
                                | at
                                  : 'flag_condition.event_condition.occurrence_identification.consecutive_occurrence_days'
                              ).name
                            }}
                          </label>
                          <input
                            type="text" autocomplete="off"
                            id="consecutive_occurrence_days"
                            class="KBA-input-text form-control"
                            name="consecutive_occurrence_days"
                            maxlength="2"
                            formControlName="consecutive_occurrence_days"
                            [ngClass]="{
                              'KBA-form-error':
                                errorData
                                | hasError
                                  : 'flag_condition.event_condition.occurrence_identification.consecutive_occurrence_days'
                            }"
                          />
                          <span class="unit">{{ labels.day_unit }}</span>
                        </div>
                      </td>
                      <td class="vertical-align-top">
                        <div class="KBA-form-date input-group">
                          <label class="input-group-addon">
                            {{
                              (
                                resource
                                | at
                                  : 'flag_condition.event_condition.occurrence_identification.decision_period'
                              ).name
                            }}
                          </label>
                          <input
                            type="text" autocomplete="off"
                            id="consecutive_occurrence_days__decision_period"
                            class="KBA-input-text form-control"
                            name="decision_period"
                            maxlength="2"
                            formControlName="decision_period"
                            [ngClass]="{
                              'KBA-form-error':
                                errorData
                                | hasError
                                  : 'flag_condition.event_condition.occurrence_identification.decision_period'
                            }"
                          />
                          <span class="unit">{{ labels.day_unit }}</span>
                        </div>
                      </td>
                    </ng-container>
                    <ng-container
                      *ngSwitchCase="evaluationCode.occurrenceDays"
                      [formGroup]="
                        flagForm.get('conditions.occurrenceDaysGroup')
                      "
                    >
                      <td class="vertical-align-top">
                        <div class="KBA-form-date input-group">
                          <label class="input-group-addon">
                            {{
                              (
                                resource
                                | at
                                  : 'flag_condition.event_condition.occurrence_identification.occurrence_days'
                              ).name
                            }}
                          </label>
                          <input
                            type="text" autocomplete="off"
                            id="occurrence_days"
                            class="KBA-input-text form-control"
                            name="occurrence_days"
                            maxlength="2"
                            formControlName="occurrence_days"
                            [ngClass]="{
                              'KBA-form-error':
                                errorData
                                | hasError
                                  : 'flag_condition.event_condition.occurrence_identification.occurrence_days'
                            }"
                          />
                          <span class="unit">{{ labels.day_unit }}</span>
                        </div>
                      </td>
                      <td class="vertical-align-top">
                        <div
                          class="KBA-form-date input-group"
                          [formGroup]="
                            flagForm.get('conditions.occurrenceDaysGroup')
                          "
                        >
                          <label class="input-group-addon">
                            {{
                              (
                                resource
                                | at
                                  : 'flag_condition.event_condition.occurrence_identification.decision_period'
                              ).name
                            }}
                          </label>
                          <input
                            type="text" autocomplete="off"
                            id="occurrence_days__decision_period"
                            class="KBA-input-text form-control"
                            name="decision_period"
                            maxlength="2"
                            formControlName="decision_period"
                            [ngClass]="{
                              'KBA-form-error':
                                errorData
                                | hasError
                                  : 'flag_condition.event_condition.occurrence_identification.decision_period'
                            }"
                          />
                          <span class="unit">{{ labels.day_unit }}</span>
                        </div>
                      </td>
                    </ng-container>
                    <ng-container
                      *ngSwitchCase="evaluationCode.accumulateOccurrenceCount"
                      [formGroup]="
                        flagForm.get(
                          'conditions.accumulateOccurrenceCountGroup'
                        )
                      "
                    >
                      <td>
                        <div class="KBA-form-date input-group">
                          <label class="input-group-addon">
                            {{
                              (
                                resource
                                | at
                                  : 'flag_condition.event_condition.occurrence_identification.accumulate_occurrence_count'
                              ).name
                            }}
                          </label>
                          <input
                            type="text" autocomplete="off"
                            id="accumulate_occurrence_count"
                            class="KBA-input-text form-control"
                            name="accumulate_occurrence_count"
                            maxlength="5"
                            formControlName="accumulate_occurrence_count"
                            [ngClass]="{
                              'KBA-form-error':
                                errorData
                                | hasError
                                  : 'flag_condition.event_condition.occurrence_identification.accumulate_occurrence_count'
                            }"
                          />
                          <span class="unit">{{ labels.time_unit }}</span>
                        </div>
                      </td>
                    </ng-container>
                  </ng-container>
                </ng-template>
              </tr>
            </ng-container>
            <tr class="KBA-form-row">
              <td class="KBA-form-table__head">
                <label class="KBA-form-table__label">
                  {{ labels.option }}
                </label>
              </td>
              <td colspan="3">
                <div class="form-group">
                  <div class="checkbox-inline">
                    <input
                      type="checkbox"
                      name="ignore_0minute"
                      id="KBA-options-ignore-zero"
                      class="KBA-input-checkbox checkbox-with-label"
                      formControlName="ignore_0minute"
                      (ngModelChange)="params.flag_condition.event_condition
                          .occurrence_identification.ignore_0minute_code = $event"
                    />
                    <label
                      for="KBA-options-ignore-zero"
                      class="KBA-input-checkbox__label"
                    >
                      {{
                        resource.flag_condition.event_condition
                          .occurrence_identification.ignore_0minute_code.name
                      }}
                    </label>
                  </div>
                </div>
              </td>
            </tr>
            <tr
              app-kba-form-table-textarea
              class="KBA-form-row"
              [formGroup]="flagForm"
              [kbaName]="'free_memo'"
              [kbaParams]="params.flag_condition"
              [kbaResource]="resource.flag_condition"
              [kbaLabel]="labels"
              [colspan]="3"
              [maxLength]="340"
              [path]="'flag_condition.free_memo'"
              [errorData]="errorData"
            ></tr>
          </tbody>
        </table>
        <footer class="KBA-form-footer-fixed">
          <a
            href="javascript:void(0)"
            (click)="onClickReset()"
            class="btn btn-link"
          >
            {{ labels.reset }}
          </a>
          <button
            class="btn btn-success"
            type="button"
            *ngIf="!isUpdate"
            (click)="onClickContinue()"
            [disabled]="flagForm.invalid || !modelRevOk"
          >
            {{ labels.continue }}
          </button>
          <button
            class="btn btn-primary"
            type="button"
            (click)="onClickSubmit()"
            [disabled]="flagForm.invalid || !modelRevOk"
          >
            {{ labels.submit }}
          </button>
        </footer>
      </form>
    </div>
  </div>

  <ng-template #submitModalContent>
    <app-kba-tandem-confirm
      class="confirm-modal-content"
      [desc]="desc"
      [val]="val"
      [customContent]="submitModalCustomContent"
    ></app-kba-tandem-confirm>
  </ng-template>

  <ng-template #resetModalContent>
    <p class="KBA-modal-message">{{ labels.reset_modal_body }}</p>
  </ng-template>

  <ng-template #submitModalCustomContent let-d="d" let-value="value">
    <ng-container [ngSwitch]="d.name">
      <p *ngSwitchCase="'flag_condition.flag_code'">
        <i
          class="fa fa-flag kba-flag"
          [ngClass]="'flag-type-' + params.flag_condition.flag_code"
        ></i>
      </p>
      <ng-container *ngSwitchCase="'flag_condition.car_conditions'">
        <table class="KBA-model-table" *ngIf="!allModels">
          <tbody>
            <ng-container *ngTemplateOutlet="modelRevDisplay"></ng-container>
          </tbody>
        </table>
        <p *ngIf="allModels">
          {{ labels.all_models }}
        </p>
      </ng-container>
      <ng-container *ngSwitchCase="'flag_condition'">
        <p *ngFor="let condition of value" class="wrap">
          <ng-container *ngIf="condition.key !== 'ignore_0minute_code'">
            {{ (resource | at: condition.key).name }} : {{ condition.value }}
          </ng-container>
        </p>
      </ng-container>
      <ng-container
        *ngSwitchCase="
          'flag_condition.event_condition.occurrence_identification.ignore_0minute_code'
        "
      >
        <p *ngIf="value === state.on">
          {{
            resource.flag_condition.event_condition.occurrence_identification
              .ignore_0minute_code.name
          }}
        </p>
      </ng-container>
      <p
        *ngSwitchCase="
          'flag_condition.event_condition.detection_condition_code'
        "
      >
        {{ evaluationCodeText }}
      </p>
      <p *ngSwitchCase="'flag_condition.free_memo'" class="free-memo">
        {{ value }}
      </p>
      <p *ngSwitchDefault>{{ value }}</p>
    </ng-container>
  </ng-template>

  <ng-template #modelRevModalContent>
    <app-kba-model-rev-modal
      #modelRevModal
      [labels]="labels"
      [resource]="resource"
      [params]="modelRevParams"
      [divisionList]="divisionList"
      [selectedDivisions]="selectedDivisions"
      [showRefModal]="showRefModal"
    ></app-kba-model-rev-modal>
  </ng-template>

  <ng-template #refModalContent>
    <div class="rev-modal-wrapper">
      <ng-container *ngFor="let profile of refModalData">
        <h2 class="reference-title">
          {{ profile.car_condition.model }}-{{ profile.car_condition.type_rev }}
        </h2>
        <table
          class="KBA-form-table KBA-table-modal table table-bordered table-reference"
          *ngIf="!!profile.flag_conditions.length; else elseBlock"
        >
          <thead class="KBA-table-thead-modal">
            <tr>
              <ng-container *ngFor="let th of refModalValues.listDesc">
                <th
                  *ngIf="th.displayable"
                  class="KBA-index-th th-{{ th.shortName }}"
                >
                  {{ th.label }}
                </th>
              </ng-container>
            </tr>
          </thead>
          <tbody class="KBA-form-table-tbody">
            <tr *ngFor="let condition of profile.flag_conditions">
              <ng-container *ngFor="let th of refModalValues.listDesc">
                <ng-container [ngSwitch]="th.name" *ngIf="th.displayable">
                  <td
                    *ngSwitchCase="
                      'flag_condition_links.flag_conditions.event_condition.event_code'
                    "
                    class="KBA-form-table__value td-event_code"
                  >
                    {{ condition | at: th.dataKey }}
                  </td>
                  <td
                    *ngSwitchCase="
                      'flag_condition_links.flag_conditions.event_condition.occurrence_identification.ignore_0minute_code'
                    "
                    class="KBA-form-table__value text-center"
                  >
                    <i
                      *ngIf="(condition | at: th.dataKey) === '1'"
                      class="fa fa-check"
                    ></i>
                  </td>
                  <td *ngSwitchDefault class="KBA-form-table__value">
                    {{ condition | at: th.dataKey }}
                  </td>
                </ng-container>
              </ng-container>
            </tr>
          </tbody>
        </table>
        <ng-template #elseBlock>
          <p class="no-profile">{{ labels.no_reference }}</p>
        </ng-template>
      </ng-container>
      <ng-container *ngIf="refModalData.length === 0">
        <p class="no-profile">{{ labels.no_reference }}</p>
      </ng-container>
    </div>
  </ng-template>

  <ng-template #modelRevDisplay>
    <ng-container *ngIf="!allModels">
      <tr class="KBA-form-row" *ngFor="let division of divisionsForDisplay">
        <td  class="KBA-model-cell">{{ division.model }}</td>
        <td colspan="2" class="KBA-rev-cell">
          <span
            class="KBA-rev-cell_value"
            *ngFor="let d of division.divisions"
            >{{ d.type_rev }}</span
          >
        </td>
      </tr>
    </ng-container>
    <ng-container *ngIf="allModels">
      <tr class="KBA-form-row">
        <td colspan="3">
          <span>{{ labels.all_models }}</span>
        </td>
      </tr>
    </ng-container>
  </ng-template>
</section>

<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
