<section id="KBA-operator-input-car-index" *ngIf="labels && resource">
  <div
    class="container-fluid"
    *ngIf="!isOpenDetail && !isOpenDeleteAll && !isOpenSettingAll"
  >
    <h2 class="KBA-operator-input-car-index__title KBA-page-title">
      {{ labels.title }}
    </h2>
    <div class="KBA-content">
      <!-- 検索 -->
      <app-kba-accordion
        [collapsed]="collapsed"
        [useCustomHeader]="false"
        [title]="labels.search_condition"
        [isLoading]="isLoading"
        [labels]="labels"
        (onChangeState)="changePanelState($event)"
      >
        <div data-kba-accordion-body>
          <div class="container KBA-search">
            <ng-container
              *ngIf="
                resource && resource.common && resource.car_operator_id_input
              "
            >
              <div class="row">
                <!-- 注目車両グループ -->
                <app-kba-selected
                  *ngIf="exists('common.target_car_group_id')"
                  class="col-sm-3"
                  [kbaName]="'target_car_group_id'"
                  [kbaParams]="params.common"
                  [kbaResource]="resource.common"
                >
                </app-kba-selected>
                <!-- 顧客 -->
                <app-kba-selected
                  *ngIf="exists('common.customer.ids')"
                  class="col-sm-3"
                  [kbaName]="'ids'"
                  [kbaParams]="params.common.customer"
                  [kbaResource]="resource.common.customer"
                >
                </app-kba-selected>
              </div>
              <div class="row">
                <!-- 車両種類 -->
                <app-kba-selected
                  *ngIf="exists('common.car_identification.division_codes')"
                  class="col-sm-3"
                  [kbaName]="'division_codes'"
                  [kbaParams]="params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                >
                </app-kba-selected>
                <!-- 機種 -->
                <app-kba-text
                  *ngIf="exists('common.car_identification.models')"
                  class="col-sm-3"
                  [kbaName]="'models'"
                  [kbaParams]="params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                  [maxlength]="20"
                >
                </app-kba-text>
                <!-- 型式 -->
                <app-kba-text
                  *ngIf="exists('common.car_identification.type_revs')"
                  class="col-sm-3"
                  [kbaName]="'type_revs'"
                  [kbaParams]="params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                  [maxlength]="20"
                >
                </app-kba-text>
                <!-- 機番 -->
                <app-kba-text
                  *ngIf="exists('common.car_identification.serials')"
                  class="col-sm-3"
                  [kbaName]="'serials'"
                  [kbaParams]="params.common.car_identification"
                  [kbaResource]="resource.common.car_identification"
                >
                </app-kba-text>
              </div>
              <div class="row">
                <!-- 顧客管理番号 -->
                <app-kba-text
                  *ngIf="
                    exists('common.customer_attribute.customer_management_no')
                  "
                  class="col-sm-3"
                  [kbaName]="'customer_management_no'"
                  [kbaParams]="params.common.customer_attribute"
                  [kbaResource]="resource.common.customer_attribute"
                  [maxlength]="26"
                >
                </app-kba-text>
                <!-- 顧客車両番号 -->
                <app-kba-text
                  *ngIf="exists('common.customer_attribute.customer_car_no')"
                  class="col-sm-3"
                  [kbaName]="'customer_car_no'"
                  [kbaParams]="params.common.customer_attribute"
                  [kbaResource]="resource.common.customer_attribute"
                  [maxlength]="26"
                >
                </app-kba-text>
                <!-- オペ識別設定 -->
                <app-kba-selected
                  *ngIf="
                    exists('car_operator_id_input.operator_identification_kind')
                  "
                  class="col-sm-3"
                  [kbaName]="'operator_identification_kind'"
                  [kbaParams]="params.car_operator_id_input"
                  [kbaResource]="resource.car_operator_id_input"
                >
                </app-kba-selected>
                <!-- 登録ステータス -->
                <app-kba-selected
                  *ngIf="
                    exists('car_operator_id_input.registration_status_kind')
                  "
                  class="col-sm-3"
                  [kbaName]="'registration_status_kind'"
                  [kbaParams]="params.car_operator_id_input"
                  [kbaResource]="resource.car_operator_id_input"
                >
                </app-kba-selected>
              </div>
              <div class="row">
                <!-- オペレータID -->
                <app-kba-text
                  *ngIf="exists('car_operator_id_input.operator_codes')"
                  class="col-sm-3"
                  [kbaName]="'operator_codes'"
                  [kbaParams]="params.car_operator_id_input"
                  [kbaResource]="resource.car_operator_id_input"
                  [maxlength]="10"
                >
                </app-kba-text>
                <!-- オペレータ名 -->
                <app-kba-text
                  *ngIf="exists('car_operator_id_input.operator_labels')"
                  class="col-sm-3"
                  [kbaName]="'operator_labels'"
                  [kbaParams]="params.car_operator_id_input"
                  [kbaResource]="resource.car_operator_id_input"
                  [maxlength]="50"
                >
                </app-kba-text>
              </div>
            </ng-container>
          </div>
          <div class="KBA-panel-footer">
            <a
              href="javascript:void(0)"
              (click)="onClickReset()"
              class="btn btn-link"
            >
              {{ labels.reset }}
            </a>
            <button
              (click)="onClickSearch()"
              type="button"
              class="btn btn-primary search"
            >
              {{ labels.search }}
            </button>
          </div>
        </div>
      </app-kba-accordion>

      <!-- ページネーション -->
      <div class="KBA-table-options" [hidden]="count <= 0">
        <app-kba-pagination
          [count]="count"
          [params]="pageParams"
          [labels]="labels"
          [element]="pageCountEl"
          (changeState)="onPaginationChange()"
        >
        </app-kba-pagination>
        <div class="table-option-buttons">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="onClickAllOperatorIdOff()"
            [disabled]="!(selectedList | isNotEmpty)"
          >
            {{ labels.operator_id_off_all }}
          </button>
          <div class="delete-wrapper">
            <span
              class="delete-warning-message"
              *ngIf="selectedList.length > batchDeleteLimit"
              >{{ labels.alert_over_upper_limit }}</span
            >
            <button
              type="button"
              class="btn btn-secondary"
              (click)="onClickAllDelete()"
              [disabled]="
                !(selectedList | isNotEmpty) ||
                selectedList.length > batchDeleteLimit
              "
            >
              {{ labels.delete_all }}
              <i class="kba-icon kba-icon-dustbox"></i>
              <span
                class="delete-count"
                [ngClass]="
                  selectedList.length > batchDeleteLimit ? 'warning' : ''
                "
              >
                {{ selectedList.length }}/{{ batchDeleteLimit
                }}{{ labels.delete_count }}
              </span>
            </button>
          </div>
          <button
            type="button"
            class="setting-on btn btn-secondary operator-id-on-all"
            (click)="onClickAllSetting()"
            [disabled]="!(selectedList | isNotEmpty)"
          >
            {{ labels.setting_all }}
          </button>
        </div>
      </div>

      <!-- テーブル -->
      <app-kba-table
        [customTableRowContent]="customTableRowContent"
        [customTableThContent]="customTableThContent"
        [lists]="lists"
        [pageParams]="pageParams"
        [params]="params"
        [thList]="thList"
        [(sortingParams)]="sortingParams"
        [sortableThList]="sortableThList"
        [labels]="labels"
        [collapsed]="collapsed"
        [selectable]="selectable"
        [checkedItems]="checkedItems"
        [isFetching]="isFetching"
        [checkIdName]="checkIdName"
        (sort)="onChangeSort($event)"
        (detail)="onClickDetail($event)"
      >
        <ng-template #customTableThContent>
          <ng-container *ngFor="let th of thList">
            <ng-container *ngIf="th.displayable">
              <th
                class="th-{{ th.shortName }} KBA-index-th"
                [ngClass]="{
                  'text-center':
                    th.shortName ===
                    'cars_car_operator_operator_identification_kind',
                  'disable-sort': !th.sortable
                }"
                appKbaSortingLabel
                [(sortingParams)]="sortingParams"
                [labelName]="th.name"
                [sortableThList]="sortableThList"
                (sort)="onChangeSort($event)"
              >
                <span>{{ th.label }}</span>
              </th>
            </ng-container>
          </ng-container>
          <th class="KBA-index-th fixed disable-sort">
            {{ labels.header_detail }}
          </th>
        </ng-template>
        <ng-template #customTableRowContent let-data="data">
          <ng-container *ngFor="let title of thList">
            <ng-container *ngIf="title.displayable">
              <!-- オペ識別設定の場合 -->
              <td
                *ngIf="
                  title.shortName ===
                  'cars_car_operator_operator_identification_kind'
                "
                [ngClass]="{
                  disable: isOperatorIdSettingKindDisabled(
                    data['cars.car_operator.registration_status_kind']
                  )
                }"
                class="KBA-table__small kba-sm-link td-{{
                  title.shortName
                }} KBA-index-td d-flex justify-content-center align-items-center"
                (click)="
                  onClickOperatorId(
                    data['cars.car_operator.operator_identification_kind'],
                    data
                  )
                "
              >
                <span
                  *ngIf="
                    isOperatorIdSettingKindOn(
                      data['cars.car_operator.operator_identification_kind']
                    )
                  "
                  class="on setting-on"
                >
                  {{ labels.id_key_on }}
                </span>
                <span
                  *ngIf="
                    !isOperatorIdSettingKindOn(
                      data['cars.car_operator.operator_identification_kind']
                    )
                  "
                  class="off"
                >
                  {{ labels.id_key_off }}
                </span>
              </td>

              <!-- 上記以外の td の場合 -->
              <td
                *ngIf="
                  title.name !==
                  'cars.car_operator.operator_identification_kind'
                "
                class="td-{{ title.shortName }} KBA-index-td d-flex align-items-center"
              >
                {{ data[title.name] }}
              </td>
            </ng-container>
          </ng-container>
          <td
            class="KBA-index-td text-center KBA-table__small kba-sm-link fixed d-flex align-items-center"
            (click)="onClickDetail(data)"
          >
            <span class="kba-icon kba-icon-detail"></span>
          </td>
        </ng-template>
      </app-kba-table>
    </div>
  </div>

  <!-- 詳細 -->
  <app-operator-input-car-detail
    *ngIf="isOpenDetail"
    [selectedCar]="detailCar"
    [customerId]="customerId"
    [params]="searchParams"
    [labels]="labels"
    [resource]="resource"
    [functions]="functions"
    [operatorFields]="operatorFields"
    [listSettingFields]="listSettingFields"
    (return)="returnFromDetail()"
  >
  </app-operator-input-car-detail>

  <!-- 一括削除 -->
  <app-operator-input-car-batch-delete
    *ngIf="isOpenDeleteAll"
    [selectedCarIds]="selectedCarIds"
    [customerId]="customerId"
    [params]="searchParams"
    [labels]="labels"
    [resource]="resource"
    [functions]="functions"
    [operatorFields]="operatorFields"
    [listSettingFields]="listSettingFields"
    [listSettingConfirmFields]="listSettingConfirmFields"
    (return)="returnFromDeleteAll($event)"
  >
  </app-operator-input-car-batch-delete>

  <!-- 一括設定 -->
  <app-operator-input-car-batch-setting
    *ngIf="isOpenSettingAll"
    [selectedCarIds]="selectedCarIds"
    [customerId]="customerId"
    [params]="searchParams"
    [labels]="labels"
    [resource]="resource"
    [functions]="functions"
    [operatorFields]="operatorFields"
    [listSettingFields]="listSettingFields"
    [listSettingConfirmFields]="listSettingConfirmFields"
    (return)="returnFromSettingAll($event)"
  >
  </app-operator-input-car-batch-setting>

  <!-- オペ識別設定一括OFF -->
  <ng-template #operatorIdSettingOffModalContent>
    <div class="subtitle">
      <p class="text-attention">{{ labels.operator_id_setting_attention }}</p>
      <p></p>
      <p class="text-attention" *ngIf="isOperatorAttentionVisible">{{ labels.operator_id_setting_attention2 }}</p>
      <p></p>
    </div>

    <app-kba-simple-list-confirm
      [desc]="settingOffModalValues.listDesc"
      [val]="settingOffModalValues.listVal"
    >
    </app-kba-simple-list-confirm>
  </ng-template>

  <!-- 結果 -->
  <ng-template #resultModalContent>
    <app-kba-simple-list-confirm
      [desc]="resultDesc"
      [val]="resultVal"
      [warningColumns]="'all'"
    >
    </app-kba-simple-list-confirm>
    <p class="result-count-message">{{ resultCountMessage }}</p>
  </ng-template>

  <!-- リセット -->
  <ng-template #resetModalContent>
    <p class="KBA-modal-message">{{ labels.reset_modal_body }}</p>
  </ng-template>
</section>

<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
