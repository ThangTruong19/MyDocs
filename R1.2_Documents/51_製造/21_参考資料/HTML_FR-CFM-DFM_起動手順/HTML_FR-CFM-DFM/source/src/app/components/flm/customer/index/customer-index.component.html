<section id="KBA-customer-index" *ngIf="labels && resource">
  <div class="container-fluid">
    <h2 class="KBA-page-title">{{ labels.title }}</h2>
    <div class="KBA-content">
      <!-- 一覧画面 -->
      <ng-container *ngIf="template === 'list'">
        <!-- 検索アコーディオン -->
        <app-kba-accordion
          [collapsed]="collapsed"
          [useCustomHeader]="false"
          [title]="labels.search_condition"
          [labels]="labels"
          (onChangeState)="changePanelState($event)"
        >
          <div data-kba-accordion-body>
            <div class="container KBA-search">
              <div class="row">
                <!-- 担当 DB -->
                <app-kba-selected
                  class="col-sm-3"
                  *ngIf="resource.support_distributor_id"
                  [kbaName]="'support_distributor_id'"
                  [kbaParams]="params"
                  [kbaResource]="resource"
                >
                </app-kba-selected>

                <!-- 顧客名称 -->
                <app-kba-text
                  class="col-sm-3"
                  [kbaName]="'customer_label'"
                  [kbaParams]="params"
                  [kbaResource]="resource"
                  [maxlength]="255"
                >
                </app-kba-text>

                <!-- 電話番号 -->
                <app-kba-text
                  class="col-sm-3"
                  [kbaName]="'phone_no'"
                  [kbaParams]="params"
                  [kbaResource]="resource"
                  [maxlength]="30"
                >
                </app-kba-text>
              </div>
            </div>
            <div class="KBA-panel-footer">
              <button
                (click)="onClickSearch()"
                type="button"
                class="btn btn-primary search"
              >
                {{ labels.search }}
              </button>
              <button
                type="button"
                class="btn btn-warning btn-download"
                (click)="onClickDownloadTemplate($event)"
              >
                {{ labels.download_all }}
                <i class="kba-icon kba-icon-download"></i>
              </button>
            </div>
          </div>
        </app-kba-accordion>

        <!-- 一覧テーブル上部検索オプション欄 -->
        <div class="KBA-table-options" [hidden]="count <= 0">
          <app-kba-pagination
            [count]="count"
            [params]="pageParams"
            [labels]="labels"
            [element]="pageCountEl"
            (changeState)="onPaginationChange()"
          >
          </app-kba-pagination>

          <div class="table-option-buttons">
            <div class="popover-wrapper">
              <button
                type="button"
                class="btn btn-secondary"
                (click)="onClickFieldSelect($event)"
              >
                {{ labels.field_select }}
              </button>
              <app-kba-popover
                [labels]="labels"
                [resource]="fieldResources"
                [fields]="fields"
                [title]="labels.field_select_title"
                [(isVisible)]="fieldSelectPopoverVisible"
                [promise]="fieldResourcesPromise"
                (ok)="onFieldSelectOk($event)"
              >
              </app-kba-popover>
            </div>
          </div>
        </div>

        <!-- 一覧テーブル -->
        <div class="KBA-table-wrapper">
          <app-kba-table
            [customTableRowContent]="customTableRowContent"
            [lists]="lists"
            [pageParams]="pageParams"
            [thList]="thList"
            [sortableThList]="sortableThList"
            [(sortingParams)]="sortingParams"
            [labels]="labels"
            [collapsed]="collapsed"
            [detailedly]="true"
            [updatable]="updatable"
            [deletable]="deletable"
            [isFetching]="isFetching"
            (edit)="onClickEdit($event)"
            (delete)="onClickDelete($event)"
            (detail)="onClickDetail($event)"
            (sort)="onChangeSort($event)"
          >
            <ng-template #customTableRowContent let-data="data">
              <ng-container *ngFor="let title of thList">
                <ng-container [ngSwitch]="title.name" *ngIf="title.displayable">
                  <!-- 時差 -->
                  <ng-container
                    *ngSwitchCase="'customers.attribute.time_difference'"
                  >
                    <td
                      class="td-{{
                        title.shortName
                      }} KBA-index-td d-flex align-items-center"
                    >
                      {{ formatTimeDifference(data[title.name]) }}
                    </td>
                  </ng-container>
                  <!-- それ以外 -->
                  <ng-container *ngSwitchDefault>
                    <td
                      class="td-{{
                        title.shortName
                      }} KBA-index-td d-flex align-items-center"
                    >
                      <p>{{ data[title.name] }}</p>
                    </td>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-template>
          </app-kba-table>
        </div>
      </ng-container>

      <!-- 詳細画面 -->
      <ng-container *ngIf="template === 'detail'">
        <div class="KBA-form">
          <app-customer-detail
            [labels]="labels"
            [resource]="resource"
            [functions]="functions"
            [detailHeaders]="detailValues.listDesc"
            [detailData]="detailValues.listVal"
            [carListFields]="carListFields"
            (clicked)="onClickBack()"
          >
          </app-customer-detail>
        </div>
      </ng-container>
    </div>
  </div>
</section>

<ng-template #deleteModalContent>
  <app-kba-tandem-confirm
    [desc]="deleteModalValues.listDesc"
    [val]="deleteModalValues.listVal"
  >
  </app-kba-tandem-confirm>
</ng-template>

<app-kba-sidemenu [isLoading]="isLoading"></app-kba-sidemenu>
